# æ–‡ä»¶å­˜å‚¨è§£æ

ç›®å‰æˆ‘æœåŠ¡å™¨çš„ç›®å½•è§„åˆ’ï¼šé¡¹ç›®å·¥ç¨‹ç›®å½•/root/kt/mrdocsï¼Œéƒ¨ç½²ç›¸å…³ç›®å½•ï¼š/root/kt/mrdocs/deploymentï¼ˆæ‰‹åŠ¨scpä¸Šä¼ ä¸Šå»çš„ï¼‰ï¼Œä½ å‘Šè¯‰æˆ‘ï¼Œæˆ‘éƒ¨ç½²èµ·æ¥åï¼Œ æ–‡ä»¶å­˜å‚¨ä½ç½®æ˜¯ä»€ä¹ˆæ ·å­çš„



  # éƒ¨ç½²è„šæœ¬ä½ç½®
  SCRIPT_DIR = /root/kt/mrdocs/deployment/scripts

  # é¡¹ç›®ç›®å½• = è„šæœ¬ç›®å½•çš„ä¸Šä¸Šçº§ (../../)
  PROJECT_DIR = /root/kt/mrdocs

#   ğŸ—‚ï¸ éƒ¨ç½²åå®Œæ•´ç›®å½•ç»“æ„

  ```
  /root/kt/mrdocs/                     # é¡¹ç›®æ ¹ç›®å½•ï¼ˆè‡ªåŠ¨ç¡®å®šï¼‰
    â”œâ”€â”€ deployment/                      # éƒ¨ç½²ç›¸å…³æ–‡ä»¶ï¼ˆä½ æ‰‹åŠ¨ä¸Šä¼ çš„ï¼‰
    â”‚   â”œâ”€â”€ scripts/
    â”‚   â”‚   â”œâ”€â”€ deploy_safe_mrdoc.sh    # å®‰å…¨éƒ¨ç½²è„šæœ¬
    â”‚   â”‚   â””â”€â”€ ubuntu_prepare.sh       # ç¯å¢ƒå‡†å¤‡è„šæœ¬
    â”‚   â”œâ”€â”€ config/
    â”‚   â””â”€â”€ SAFE_DEPLOYMENT_PLAN.md
    â”œâ”€â”€ media/              â¬…ï¸ **ä¸Šä¼ æ–‡ä»¶å­˜å‚¨ä½ç½®**
    â”‚   â”œâ”€â”€ uploads/                     # æ–‡æ¡£é™„ä»¶
    â”‚   â”œâ”€â”€ images/                      # å›¾ç‰‡èµ„æº
    â”‚   â”œâ”€â”€ documents/                   # æ–‡æ¡£æ–‡ä»¶
    â”‚   â””â”€â”€ temp/                        # ä¸´æ—¶æ–‡ä»¶
    â”œâ”€â”€ logs/               â¬…ï¸ **åº”ç”¨æ—¥å¿—å­˜å‚¨**
    â”œâ”€â”€ static/             â¬…ï¸ **é™æ€æ–‡ä»¶å­˜å‚¨**
    â”œâ”€â”€ config/             â¬…ï¸ **é…ç½®æ–‡ä»¶å­˜å‚¨**
    â”œâ”€â”€ docker/
    â”‚   â”œâ”€â”€ docker-compose.yml
    â”‚   â””â”€â”€ Dockerfile
    â”œâ”€â”€ manage.py                        # Djangoç®¡ç†è„šæœ¬ï¼ˆå…‹éš†æºç ï¼‰
    â”œâ”€â”€ requirements.txt                 # ä¾èµ–æ–‡ä»¶ï¼ˆå…‹éš†æºç ï¼‰
    â””â”€â”€ ...                             # å…¶ä»–æºç æ–‡ä»¶
  ```



  ğŸ“Š æ–‡ä»¶å­˜å‚¨è¯¦ç»†è¯´æ˜

#   ğŸ¯ ä¸Šä¼ æ–‡ä»¶å­˜å‚¨ä½ç½®

  æœåŠ¡å™¨å­˜å‚¨è·¯å¾„ï¼š
 ```
  /root/kt/mrdocs/media/              # æ‰€æœ‰é€šè¿‡webç«¯ä¸Šä¼ çš„æ–‡ä»¶
   â”œâ”€â”€ uploads/                        # æ–‡æ¡£é™„ä»¶ï¼ˆPDFã€Wordç­‰ï¼‰
   â”œâ”€â”€ images/                         # å›¾ç‰‡èµ„æºï¼ˆPNGã€JPGç­‰ï¼‰
   â”œâ”€â”€ documents/                      # æ–‡æ¡£å¯¼å‡ºæ–‡ä»¶
   â””â”€â”€ temp/                          # ä¸´æ—¶ä¸Šä¼ æ–‡ä»¶
 ```



#   ğŸ”— Dockerå·æ˜ å°„å…³ç³»

docker-compose.yml ä¸­çš„å·æ˜ å°„

 ```yaml
  volumes:
 
    - ./media:/app/media              # /root/kt/mrdocs/media â†” å®¹å™¨/app/media
      - ./logs:/app/logs                # /root/kt/mrdocs/logs â†” å®¹å™¨/app/logs
        - ./static:/app/static            # /root/kt/mrdocs/static â†” å®¹å™¨/app/static
        - ./config:/app/config            # /root/kt/mrdocs/config â†” å®¹å™¨/app/config
 ```



#   ğŸ› ï¸ æ–‡ä»¶ç®¡ç†æ“ä½œ

  ğŸ“‚ æŸ¥çœ‹ä¸Šä¼ æ–‡ä»¶

  ## æŸ¥çœ‹æ‰€æœ‰ä¸Šä¼ æ–‡ä»¶
  ls -la /root/kt/mrdocs/media/

  ## æŸ¥çœ‹ç›®å½•å¤§å°
  du -sh /root/kt/mrdocs/media/

  ## æŒ‰ç±»å‹æŸ¥çœ‹æ–‡ä»¶
  find /root/kt/mrdocs/media/ -name "*.pdf" -type f
  find /root/kt/mrdocs/media/ -name "*.jpg" -o -name "*.png" -type f

  ğŸ’¾ å¤‡ä»½ä¸Šä¼ æ–‡ä»¶

  ## å¤‡ä»½æ‰€æœ‰ä¸Šä¼ æ–‡ä»¶
  cd /root/kt/
  tar -czf mrdoc_media_backup_$(date +%Y%m%d).tar.gz mrdocs/media/

  ## å®šæœŸå¤‡ä»½è„šæœ¬ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹ï¼‰
  echo "0 2 * * * tar -czf /backup/mrdoc_media_\$(date +\%Y\%m\%d).tar.gz -C /root/kt mrdocs/media/" | crontab -

  ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶

  ## æ¸…ç†7å¤©å‰çš„ä¸´æ—¶æ–‡ä»¶
  find /root/kt/mrdocs/media/temp/ -type f -mtime +7 -delete

  ## æ¸…ç†å¤§æ–‡ä»¶ï¼ˆè¶…è¿‡100MBï¼‰
  find /root/kt/mrdocs/media/ -size +100M -type f -ls



#   ğŸ”’ å®‰å…¨æ€§è¯´æ˜

  âœ… å­˜å‚¨å®‰å…¨ç‰¹ç‚¹

  - âœ… ç‹¬ç«‹å­˜å‚¨ - æ–‡ä»¶å­˜å‚¨åœ¨ /root/kt/mrdocs/media/ï¼Œä¸ç³»ç»Ÿå…¶ä»–æœåŠ¡å®Œå…¨éš”ç¦»
  - âœ… æŒä¹…åŒ– - å®¹å™¨é‡å¯/æ›´æ–°ä¸å½±å“å·²ä¸Šä¼ æ–‡ä»¶
  - âœ… ä¾¿äºç®¡ç† - æ‰€æœ‰æ–‡ä»¶é›†ä¸­åœ¨ä¸€ä¸ªç›®å½•ï¼Œä¾¿äºå¤‡ä»½å’Œè¿ç§»
  - âœ… æƒé™æ§åˆ¶ - æ–‡ä»¶æƒé™ç»§æ‰¿ /root/kt/ ç›®å½•æƒé™è®¾ç½®

  æ€»ç»“ï¼šéƒ¨ç½²åï¼Œæ‰€æœ‰é€šè¿‡MrDoc webç«¯ä¸Šä¼ çš„é™„ä»¶å’Œç´ æéƒ½ä¼šå­˜å‚¨åœ¨ /root/kt/mrdocs/media/ ç›®å½•ä¸­ã€‚ ğŸ“âœ…