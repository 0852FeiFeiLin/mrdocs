# MrDoc 安全更新流程指南

## 概述

本文档提供了一套完整的安全更新流程，确保在修改代码后能够安全、可靠地更新生产环境，并在出现问题时能够快速回滚。

**核心原则：先备份，再更新，后验证** 🎯

---

## 🛡️ 完整的安全更新流程（8步法）

### 步骤 1️⃣：检查当前状态

在进行任何更新操作前，先确认系统当前状态正常。

```bash
# 进入项目目录
cd /root/kt/mrdocs

# 查看容器状态
docker ps --filter "name=mrdocs-safe"

# 测试应用是否正常
curl -I http://localhost:8081

# 查看当前版本
git log -1 --oneline
```

**预期结果**：
- 所有容器状态为 `Up`
- 应用返回 `HTTP/1.1 200 OK`
- Git 显示当前版本信息

---

### 步骤 2️⃣：查看修改内容

详细了解本次修改涉及的文件和内容。

```bash
# 查看修改的文件列表
git status

# 查看简洁的修改摘要
git status -s

# 查看详细修改内容
git diff

# 查看特定文件的修改
git diff app_doc/views.py

# 确认修改无误后继续
```

**检查要点**：
- 确认所有修改都是预期的
- 没有误删重要文件
- 没有意外修改配置文件

---

### 步骤 3️⃣：创建完整备份（重要！）

**⚠️ 这是最重要的步骤，切勿跳过！**

```bash
# 创建带时间戳的备份目录
BACKUP_DIR=/backup/mrdocs/$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR

echo "备份目录: $BACKUP_DIR"

# 1. 备份数据库（必须）
cp /root/kt/mrdocs/config/db.sqlite3 $BACKUP_DIR/
echo "✓ 数据库已备份"

# 2. 备份配置文件（必须）
tar -czf $BACKUP_DIR/config.tar.gz /root/kt/mrdocs/config/
echo "✓ 配置文件已备份"

# 3. 备份媒体文件（可选，如果文件很大可跳过）
MEDIA_SIZE=$(du -sh /root/kt/mrdocs/media | cut -f1)
echo "媒体文件大小: $MEDIA_SIZE"
# 如果媒体文件不大，建议备份
tar -czf $BACKUP_DIR/media.tar.gz /root/kt/mrdocs/media/
echo "✓ 媒体文件已备份"

# 4. 记录当前Git版本（重要）
git log -1 > $BACKUP_DIR/git_version.txt
echo "✓ Git版本已记录"

# 5. 记录容器状态
docker ps --filter "name=mrdocs-safe" > $BACKUP_DIR/container_status.txt
echo "✓ 容器状态已记录"

echo "━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✓ 备份完成: $BACKUP_DIR"
echo "━━━━━━━━━━━━━━━━━━━━━━━━"
```

**备份检查清单**：
- [ ] 数据库文件已备份
- [ ] 配置文件已备份
- [ ] Git版本已记录
- [ ] 备份目录可访问

---

### 步骤 4️⃣：分析修改类型，选择更新策略

根据修改的文件类型，选择相应的更新策略。

#### 修改类型与更新策略对照表

| 修改类型 | 需要操作 | 停机时间 | 风险等级 |
|---------|---------|---------|---------|
| Python代码（*.py） | 重建容器 | ~2-5分钟 | 中 |
| 模板文件（*.html） | 重启容器 | ~10秒 | 低 |
| 静态文件（CSS/JS/图片） | 无需重启 | 0秒 | 极低 |
| requirements.txt | 重建容器 | ~5-10分钟 | 高 |
| 配置文件（config/*） | 重启容器 | ~10秒 | 低 |
| 部署文件（deployment/*） | 重建容器 | ~2-5分钟 | 中 |
| models.py | 重建+迁移 | ~2-5分钟 | 高 |

#### 自动判断脚本

```bash
# 检查修改类型
MODIFIED_FILES=$(git status -s | awk '{print $2}')

NEED_REBUILD=false
NEED_RESTART=false
NEED_MIGRATE=false

for file in $MODIFIED_FILES; do
    case $file in
        *.py)
            echo "检测到 Python 代码修改: $file"
            NEED_REBUILD=true
            if [[ $file == *"models.py" ]]; then
                echo "⚠ 需要数据库迁移"
                NEED_MIGRATE=true
            fi
            ;;
        *.html)
            echo "检测到模板文件修改: $file"
            NEED_RESTART=true
            ;;
        static/*)
            echo "检测到静态文件修改: $file"
            ;;
        requirements.txt)
            echo "检测到依赖修改: $file"
            NEED_REBUILD=true
            ;;
        deployment/*)
            echo "检测到部署配置修改: $file"
            NEED_REBUILD=true
            ;;
        config/*)
            echo "检测到配置文件修改: $file"
            NEED_RESTART=true
            ;;
    esac
done

echo ""
echo "更新策略："
echo "  需要重建容器: $NEED_REBUILD"
echo "  需要重启容器: $NEED_RESTART"
echo "  需要数据库迁移: $NEED_MIGRATE"
```

---

### 步骤 5️⃣：执行更新

根据步骤4的分析结果，选择相应的更新方式。

#### 场景A：修改了Python代码、依赖或部署配置（需要重建）

```bash
cd /root/kt/mrdocs/deployment/docker

# 1. 停止容器
echo "停止现有容器..."
docker-compose down

# 2. 重建镜像（不使用缓存，确保更新生效）
echo "重建镜像（可能需要几分钟）..."
docker-compose build --no-cache mrdocs-safe-app

# 3. 启动新容器
echo "启动新容器..."
docker-compose up -d

# 4. 等待容器启动
echo "等待容器启动..."
sleep 15

echo "✓ 容器重建完成"
```

#### 场景B：仅修改了模板或配置文件（只需重启）

```bash
cd /root/kt/mrdocs/deployment/docker

# 重启应用容器
echo "重启应用容器..."
docker-compose restart mrdocs-safe-app

# 等待启动
echo "等待容器启动..."
sleep 10

echo "✓ 容器重启完成"
```

#### 场景C：仅修改了静态文件（无需重启）

```bash
# 方式1：直接刷新浏览器
# 在浏览器中按 Ctrl+F5 强制刷新即可

# 方式2：收集静态文件（如果修改的是应用内静态文件）
docker exec mrdocs-safe-app python manage.py collectstatic --noinput

echo "✓ 静态文件已更新，请刷新浏览器"
```

---

### 步骤 6️⃣：执行后续维护操作

#### 数据库迁移（如果修改了 models.py）

```bash
echo "执行数据库迁移..."

# 生成迁移文件
docker exec mrdocs-safe-app python manage.py makemigrations

# 查看待执行的迁移
docker exec mrdocs-safe-app python manage.py showmigrations

# 执行迁移
docker exec mrdocs-safe-app python manage.py migrate

echo "✓ 数据库迁移完成"
```

#### 收集静态文件（如果有新的静态文件）

```bash
echo "收集静态文件..."
docker exec mrdocs-safe-app python manage.py collectstatic --noinput
echo "✓ 静态文件收集完成"
```

#### 清理缓存（可选）

```bash
# 清理 Django 会话
docker exec mrdocs-safe-app python manage.py clearsessions

# 清理 Redis 缓存（谨慎操作）
# docker exec mrdocs-safe-redis redis-cli -a redispassword123 FLUSHDB
```

---

### 步骤 7️⃣：验证更新结果

全面验证系统是否正常运行。

```bash
echo "开始验证更新结果..."
echo ""

# 1. 检查容器状态
echo "1. 检查容器状态..."
docker ps --filter "name=mrdocs-safe"

# 2. 检查容器健康状态
echo ""
echo "2. 检查容器健康状态..."
docker inspect mrdocs-safe-app --format='{{.State.Health.Status}}'

# 3. 测试应用访问
echo ""
echo "3. 测试应用访问..."
if curl -sf http://localhost:8081 > /dev/null; then
    echo "✓ 应用访问正常"
else
    echo "✗ 应用访问失败！"
    exit 1
fi

# 4. 测试静态文件
echo ""
echo "4. 测试静态文件..."
if curl -sf http://localhost:8081/static/layui/layui.js > /dev/null; then
    echo "✓ 静态文件访问正常"
else
    echo "⚠ 静态文件访问异常"
fi

# 5. 查看应用日志（检查是否有错误）
echo ""
echo "5. 查看应用日志（最近50行）..."
docker logs --tail 50 mrdocs-safe-app

# 6. 检查是否有错误日志
echo ""
echo "6. 检查错误日志..."
ERROR_COUNT=$(docker logs mrdocs-safe-app 2>&1 | grep -i error | wc -l)
if [ $ERROR_COUNT -eq 0 ]; then
    echo "✓ 无错误日志"
else
    echo "⚠ 发现 $ERROR_COUNT 条错误日志，请检查"
fi

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✓ 自动验证完成"
echo "━━━━━━━━━━━━━━━━━━━━━━━━"
```

#### 手动功能测试清单

在浏览器中测试以下功能：

- [ ] 访问首页正常
- [ ] 用户登录/注册正常
- [ ] 文档创建/编辑正常
- [ ] 文档搜索正常
- [ ] 图片上传正常
- [ ] 页面样式显示正常
- [ ] 无 JavaScript 错误（按F12查看控制台）

---

### 步骤 8️⃣：记录更新信息

记录本次更新的详细信息，便于后续追溯。

```bash
# 创建更新记录
cat > $BACKUP_DIR/update_log.txt << EOF
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
MrDoc 更新记录
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

更新时间: $(date '+%Y-%m-%d %H:%M:%S')
操作人员: $(whoami)
服务器: $(hostname)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
修改文件:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
$(git status -s)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Git版本:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
$(git log -1)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
更新策略:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
- 重建容器: $NEED_REBUILD
- 重启容器: $NEED_RESTART
- 数据库迁移: $NEED_MIGRATE

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
容器状态:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
$(docker ps --filter "name=mrdocs-safe")

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
验证结果:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
- 容器运行: 正常 ✓
- 应用访问: 正常 ✓
- 静态文件: 正常 ✓
- 功能测试: 已通过 ✓

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
备份位置:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
$BACKUP_DIR

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
EOF

echo "✓ 更新记录已保存: $BACKUP_DIR/update_log.txt"
cat $BACKUP_DIR/update_log.txt
```

---

## 🚨 紧急回滚流程

如果更新后发现严重问题，立即执行回滚。

### 快速回滚（恢复数据库和代码）

```bash
# 设置备份目录（替换为实际的备份时间戳）
BACKUP_DIR=/backup/mrdocs/20250930_120000

echo "开始回滚到: $BACKUP_DIR"

# 1. 停止容器
cd /root/kt/mrdocs/deployment/docker
docker-compose stop mrdocs-safe-app
echo "✓ 容器已停止"

# 2. 恢复数据库
cp $BACKUP_DIR/db.sqlite3 /root/kt/mrdocs/config/
echo "✓ 数据库已恢复"

# 3. 回退代码（如果需要）
cd /root/kt/mrdocs
git log -5 --oneline  # 查看最近的提交
git reset --hard <commit-hash>  # 回退到指定版本
# 或者
git reset --hard HEAD~1  # 回退到上一个版本
echo "✓ 代码已回退"

# 4. 恢复静态文件
git restore static/
echo "✓ 静态文件已恢复"

# 5. 重建并启动容器
cd /root/kt/mrdocs/deployment/docker
docker-compose up -d --build
echo "✓ 容器已重启"

# 6. 等待启动
sleep 15

# 7. 验证
curl -I http://localhost:8081
docker logs --tail 30 mrdocs-safe-app

echo "━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✓ 回滚完成"
echo "━━━━━━━━━━━━━━━━━━━━━━━━"
```

### 完全恢复（包括媒体文件）

```bash
BACKUP_DIR=/backup/mrdocs/20250930_120000

# 执行快速回滚步骤后，再恢复媒体文件

# 1. 恢复媒体文件
cd /root/kt/mrdocs
rm -rf media/*
tar -xzf $BACKUP_DIR/media.tar.gz -C /
echo "✓ 媒体文件已恢复"

# 2. 恢复配置文件
tar -xzf $BACKUP_DIR/config.tar.gz -C /
echo "✓ 配置文件已恢复"

# 3. 重启容器
cd deployment/docker
docker-compose restart

echo "✓ 完全恢复完成"
```

---

## 📋 实际操作示例

### 示例1：修改了 views.py

```bash
# 完整流程
cd /root/kt/mrdocs

# 1. 查看修改
git diff app_doc/views.py

# 2. 备份
BACKUP_DIR=/backup/mrdocs/$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR
cp config/db.sqlite3 $BACKUP_DIR/
echo "✓ 备份完成: $BACKUP_DIR"

# 3. 更新（Python代码修改需要重建）
cd deployment/docker
docker-compose down
docker-compose build --no-cache mrdocs-safe-app
docker-compose up -d

# 4. 等待启动
sleep 15

# 5. 验证
curl -I http://localhost:8081
docker logs --tail 30 mrdocs-safe-app

# 6. 浏览器测试功能

echo "✓ 更新完成"
```

### 示例2：修改了模板文件 detail.html

```bash
cd /root/kt/mrdocs

# 1. 查看修改
git diff app_doc/templates/app_doc/doc_detail.html

# 2. 备份（模板修改风险低，但仍建议备份）
cp config/db.sqlite3 /backup/db_$(date +%Y%m%d_%H%M%S).sqlite3

# 3. 重启（模板修改只需重启）
cd deployment/docker
docker-compose restart mrdocs-safe-app

# 4. 等待启动
sleep 10

# 5. 验证
curl -I http://localhost:8081

echo "✓ 更新完成"
```

### 示例3：修改了 CSS 样式

```bash
# 修改静态文件无需重启！

# 1. 编辑文件
vim /root/kt/mrdocs/static/mrdoc/mrdoc.css

# 2. 如果是应用内静态文件，收集一下
docker exec mrdocs-safe-app python manage.py collectstatic --noinput

# 3. 浏览器中按 Ctrl+F5 强制刷新

echo "✓ 样式已更新"
```

### 示例4：修改了 models.py（需要迁移）

```bash
cd /root/kt/mrdocs

# 1. 查看修改
git diff app_doc/models.py

# 2. 备份（数据库迁移风险高，必须备份！）
BACKUP_DIR=/backup/mrdocs/$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR
cp config/db.sqlite3 $BACKUP_DIR/
echo "✓ 备份完成"

# 3. 重建容器
cd deployment/docker
docker-compose down
docker-compose build --no-cache mrdocs-safe-app
docker-compose up -d
sleep 15

# 4. 执行迁移
docker exec mrdocs-safe-app python manage.py makemigrations
docker exec mrdocs-safe-app python manage.py migrate

# 5. 验证
curl -I http://localhost:8081
docker logs --tail 30 mrdocs-safe-app

echo "✓ 更新和迁移完成"
```

### 示例5：添加了新的依赖包

```bash
cd /root/kt/mrdocs

# 1. 查看修改
git diff requirements.txt

# 2. 备份
cp config/db.sqlite3 /backup/db_$(date +%Y%m%d_%H%M%S).sqlite3

# 3. 重建容器（必须重建才能安装新包）
cd deployment/docker
docker-compose down
docker-compose build --no-cache mrdocs-safe-app
docker-compose up -d

# 4. 等待启动
sleep 20

# 5. 验证新包是否安装
docker exec mrdocs-safe-app pip list | grep your-new-package

# 6. 验证应用
curl -I http://localhost:8081
docker logs --tail 30 mrdocs-safe-app

echo "✓ 依赖更新完成"
```

---

## ⚡ 快速命令参考

### 一键安全更新（适用于Python代码修改）

```bash
cd /root/kt/mrdocs && \
cp config/db.sqlite3 /backup/db_$(date +%Y%m%d_%H%M%S).sqlite3 && \
cd deployment/docker && \
docker-compose down && \
docker-compose up -d --build && \
sleep 15 && \
docker logs --tail 30 mrdocs-safe-app && \
curl -I http://localhost:8081
```

### 快速重启（适用于模板或配置修改）

```bash
cd /root/kt/mrdocs/deployment/docker && \
docker-compose restart mrdocs-safe-app && \
sleep 10 && \
curl -I http://localhost:8081
```

### 快速回滚

```bash
BACKUP_DIR=/backup/mrdocs/[时间戳] && \
cd /root/kt/mrdocs/deployment/docker && \
docker-compose stop mrdocs-safe-app && \
cp $BACKUP_DIR/db.sqlite3 /root/kt/mrdocs/config/ && \
docker-compose start mrdocs-safe-app
```

---

## 📝 更新前检查清单

在执行更新前，请确认：

- [ ] 已备份数据库
- [ ] 已备份配置文件
- [ ] 已记录当前Git版本
- [ ] 已查看并确认所有修改
- [ ] 了解修改的影响范围
- [ ] 选择了正确的更新策略
- [ ] 选择了合适的维护时间窗口
- [ ] 已通知相关用户（如有必要）
- [ ] 准备好回滚方案

---

## ✅ 更新后验证清单

更新完成后，请验证：

- [ ] 所有容器状态为 `Up` 且 `healthy`
- [ ] 应用可以正常访问（http://server:8081）
- [ ] 静态文件加载正常（CSS/JS/图片）
- [ ] 数据库迁移成功（如有）
- [ ] 日志无严重错误
- [ ] 主要功能测试通过
- [ ] 用户登录正常
- [ ] 文档创建/编辑正常
- [ ] 已记录更新日志

---

## 🔧 故障排查

### 问题1：容器启动失败

```bash
# 查看容器日志
docker logs mrdocs-safe-app

# 查看容器状态
docker inspect mrdocs-safe-app

# 检查磁盘空间
df -h

# 检查权限
ls -la /root/kt/mrdocs/config/

# 尝试完全重建
cd /root/kt/mrdocs/deployment/docker
docker-compose down -v
docker-compose up -d --build
```

### 问题2：应用无法访问

```bash
# 检查端口是否被占用
netstat -tulpn | grep 8081

# 检查 Nginx 状态
docker logs mrdocs-safe-nginx

# 测试应用容器直接访问
docker exec mrdocs-safe-app curl -I http://localhost:8000

# 重启 Nginx
docker-compose restart mrdocs-safe-nginx
```

### 问题3：静态文件404

```bash
# 恢复静态文件
cd /root/kt/mrdocs
git restore static/

# 收集静态文件
docker exec mrdocs-safe-app python manage.py collectstatic --noinput

# 检查挂载
docker exec mrdocs-safe-nginx ls -la /var/www/static/

# 重启 Nginx
docker-compose restart mrdocs-safe-nginx
```

### 问题4：数据库迁移失败

```bash
# 查看迁移状态
docker exec mrdocs-safe-app python manage.py showmigrations

# 查看详细错误
docker logs mrdocs-safe-app 2>&1 | grep -A 10 "migrate"

# 回滚数据库
docker-compose stop mrdocs-safe-app
cp $BACKUP_DIR/db.sqlite3 /root/kt/mrdocs/config/
docker-compose start mrdocs-safe-app
```

---

## 📞 获取帮助

如遇到问题，可以：

1. 查看容器日志：`docker logs mrdocs-safe-app`
2. 查看部署文档：`/root/kt/mrdocs/deployment/部署文档.md`
3. 查看维护手册：`/root/kt/mrdocs/deployment/维护操作手册.md`
4. GitHub Issues：https://github.com/0852FeiFeiLin/mrdocs/issues

---

## 📌 重要提示

1. **永远先备份！** 特别是数据库文件
2. **在非高峰期进行更新**，避免影响用户使用
3. **一次只做一类修改**，便于定位问题
4. **充分测试后再更新生产环境**
5. **保持备份至少7天**，以便随时回滚
6. **记录每次更新**，建立变更历史
7. **准备好回滚方案**，能够在5分钟内回滚

---

**文档版本**: v1.0
**创建日期**: 2025-09-30
**维护人员**: Arise
**更新日期**: 2025-09-30

---

**关键词**：安全更新、备份恢复、容器部署、Docker、故障排查、回滚流程
