# MrDoc 维护操作手册

## 目录
- [日常维护操作](#日常维护操作)
- [代码更新流程](#代码更新流程)
- [数据库管理](#数据库管理)
- [静态文件管理](#静态文件管理)
- [配置文件修改](#配置文件修改)
- [容器管理](#容器管理)
- [监控和日志](#监控和日志)
- [常见维护场景](#常见维护场景)

---

## 日常维护操作

### 查看服务状态
```bash
# 查看所有容器状态
docker ps --filter "name=mrdocs-safe"

# 查看容器详细信息
docker inspect mrdocs-safe-app
docker inspect mrdocs-safe-nginx
docker inspect mrdocs-safe-redis

# 查看资源使用情况
docker stats mrdocs-safe-app mrdocs-safe-nginx mrdocs-safe-redis
```

### 查看日志
```bash
# 实时查看应用日志
docker logs -f mrdocs-safe-app

# 查看最近 100 行日志
docker logs --tail 100 mrdocs-safe-app

# 查看 Nginx 访问日志
docker logs mrdocs-safe-nginx | grep -E "GET|POST"

# 查看错误日志
docker logs mrdocs-safe-app 2>&1 | grep -i error
```

### 进入容器调试
```bash
# 进入应用容器
docker exec -it mrdocs-safe-app bash

# 进入 Nginx 容器
docker exec -it mrdocs-safe-nginx sh

# 进入 Redis 容器
docker exec -it mrdocs-safe-redis sh

# 在容器内执行单个命令
docker exec mrdocs-safe-app python manage.py check
```

---

## 代码更新流程

### 场景1：修改本地代码后更新

**适用场景**：你直接在服务器上修改了代码，需要重新部署

```bash
# 1. 进入项目目录
cd /root/kt/mrdocs

# 2. 查看修改的文件
git status

# 3. 备份当前数据（重要！）
cp config/db.sqlite3 /backup/db.sqlite3.$(date +%Y%m%d_%H%M%S)
tar -czf /backup/media_$(date +%Y%m%d_%H%M%S).tar.gz media/

# 4. 重建应用容器
cd deployment/docker
docker-compose up -d --build mrdocs-safe-app

# 5. 查看启动日志，确认无错误
docker logs -f mrdocs-safe-app

# 6. 测试应用
curl -I http://localhost:8081
```

**注意事项**：
- 只有修改了 Python 代码、依赖、配置文件才需要重建容器
- 修改静态文件（CSS/JS）不需要重建容器，直接刷新浏览器即可
- 修改模板文件（HTML）在 `DEBUG=False` 时需要重启容器

### 场景2：从 Git 拉取最新代码

**适用场景**：从远程仓库更新代码

```bash
# 1. 备份当前数据
cd /root/kt/mrdocs
cp config/db.sqlite3 /backup/db.sqlite3.$(date +%Y%m%d_%H%M%S)

# 2. 暂存当前修改（如果有）
git stash save "本地修改_$(date +%Y%m%d_%H%M%S)"

# 3. 拉取最新代码
git pull origin master

# 4. 恢复静态文件（防止被删除）
git restore static/

# 5. 重建容器
cd deployment/docker
docker-compose down
docker-compose up -d --build

# 6. 执行数据库迁移（如果有新的迁移）
docker exec mrdocs-safe-app python manage.py migrate

# 7. 收集静态文件（如果有新的静态文件）
docker exec mrdocs-safe-app python manage.py collectstatic --noinput

# 8. 查看应用状态
docker ps --filter "name=mrdocs-safe"
curl -I http://localhost:8081
```

### 场景3：仅修改了静态文件

**适用场景**：修改了 CSS、JavaScript、图片等静态文件

```bash
# 1. 修改静态文件
vim /root/kt/mrdocs/static/mrdoc/mrdoc.css

# 2. 无需重启容器，直接刷新浏览器
# 如果浏览器有缓存，按 Ctrl+F5 强制刷新

# 3. 如果修改的是应用内的静态文件，需要收集
docker exec mrdocs-safe-app python manage.py collectstatic --noinput

# 4. 清除浏览器缓存或等待 30 天缓存过期
# Nginx 配置的静态文件缓存时间为 30 天
```

### 场景4：仅修改了模板文件

**适用场景**：修改了 HTML 模板

```bash
# 1. 修改模板文件
vim /root/kt/mrdocs/app_doc/templates/app_doc/doc_detail.html

# 2. 重启应用容器（DEBUG=False 时需要）
docker-compose restart mrdocs-safe-app

# 3. 查看启动日志
docker logs -f mrdocs-safe-app

# 4. 测试修改
curl http://localhost:8081/your-page/
```

### 场景5：修改了依赖（requirements.txt）

**适用场景**：添加、删除或升级了 Python 包

```bash
# 1. 修改 requirements.txt
vim /root/kt/mrdocs/requirements.txt

# 2. 重新构建镜像（必须）
cd /root/kt/mrdocs/deployment/docker
docker-compose build --no-cache mrdocs-safe-app

# 3. 重启容器
docker-compose up -d mrdocs-safe-app

# 4. 验证新包是否安装
docker exec mrdocs-safe-app pip list | grep your-package

# 5. 查看启动日志
docker logs -f mrdocs-safe-app
```

### 场景6：修改了配置文件

**适用场景**：修改了 `config.ini`、`settings.py` 等配置

```bash
# 1. 修改配置文件
vim /root/kt/mrdocs/config/config.ini
# 或
vim /root/kt/mrdocs/MrDoc/settings.py

# 2. 如果修改的是挂载的配置文件（config/），只需重启
docker-compose restart mrdocs-safe-app

# 3. 如果修改的是项目内的配置文件（settings.py），需要重建
docker-compose up -d --build mrdocs-safe-app

# 4. 查看启动日志确认配置生效
docker logs -f mrdocs-safe-app
```

---

## 数据库管理

### 执行数据库迁移

```bash
# 1. 创建新的迁移文件（修改了 models.py 后）
docker exec mrdocs-safe-app python manage.py makemigrations

# 2. 查看待执行的迁移
docker exec mrdocs-safe-app python manage.py showmigrations

# 3. 执行迁移
docker exec mrdocs-safe-app python manage.py migrate

# 4. 查看特定应用的迁移
docker exec mrdocs-safe-app python manage.py showmigrations app_doc
```

### 数据库备份

```bash
# 手动备份
cp /root/kt/mrdocs/config/db.sqlite3 /backup/db.sqlite3.$(date +%Y%m%d_%H%M%S)

# 创建定时备份脚本
cat > /root/backup_mrdocs.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/backup/mrdocs"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# 备份数据库
cp /root/kt/mrdocs/config/db.sqlite3 $BACKUP_DIR/db_$DATE.sqlite3

# 备份媒体文件（每天一次）
if [ $(date +%H) -eq 02 ]; then
    tar -czf $BACKUP_DIR/media_$DATE.tar.gz /root/kt/mrdocs/media/
fi

# 删除 7 天前的备份
find $BACKUP_DIR -name "db_*.sqlite3" -mtime +7 -delete
find $BACKUP_DIR -name "media_*.tar.gz" -mtime +30 -delete

echo "备份完成: $DATE"
EOF

chmod +x /root/backup_mrdocs.sh

# 添加到定时任务（每小时备份一次数据库）
crontab -e
# 添加以下行：
# 0 * * * * /root/backup_mrdocs.sh >> /var/log/mrdocs_backup.log 2>&1
```

### 数据库恢复

```bash
# 1. 停止应用
docker-compose stop mrdocs-safe-app

# 2. 恢复数据库文件
cp /backup/db.sqlite3.20250930_120000 /root/kt/mrdocs/config/db.sqlite3

# 3. 设置权限
chmod 664 /root/kt/mrdocs/config/db.sqlite3

# 4. 启动应用
docker-compose start mrdocs-safe-app

# 5. 验证数据
docker logs -f mrdocs-safe-app
```

### 数据库维护命令

```bash
# 进入 Django Shell
docker exec -it mrdocs-safe-app python manage.py shell

# 在 Shell 中执行操作
>>> from django.contrib.auth.models import User
>>> User.objects.all()
>>> User.objects.filter(username='admin').update(email='new@email.com')

# 创建新的超级用户
docker exec -it mrdocs-safe-app python manage.py createsuperuser

# 修改用户密码
docker exec -it mrdocs-safe-app python manage.py changepassword admin

# 清理过期会话
docker exec mrdocs-safe-app python manage.py clearsessions
```

---

## 静态文件管理

### 收集静态文件

```bash
# 收集所有静态文件到 static/ 目录
docker exec mrdocs-safe-app python manage.py collectstatic --noinput

# 清除并重新收集
docker exec mrdocs-safe-app python manage.py collectstatic --noinput --clear

# 查看收集的文件
docker exec mrdocs-safe-app ls -la /app/static/
```

### 静态文件问题排查

```bash
# 1. 检查静态文件是否存在
ls -la /root/kt/mrdocs/static/layui/layui.js

# 2. 检查 Nginx 容器内的挂载
docker exec mrdocs-safe-nginx ls -la /var/www/static/layui/layui.js

# 3. 恢复被删除的静态文件
cd /root/kt/mrdocs
git restore static/

# 4. 测试静态文件访问
curl -I http://localhost:8081/static/layui/layui.js

# 5. 查看 Nginx 错误日志
docker logs mrdocs-safe-nginx 2>&1 | grep error
```

---

## 配置文件修改

### 修改环境变量

```bash
# 1. 编辑 docker-compose.yml
vim /root/kt/mrdocs/deployment/docker/docker-compose.yml

# 2. 修改环境变量，例如：
# - DJANGO_DEBUG=True  # 启用调试模式
# - REDIS_PASSWORD=new_password

# 3. 重启容器使配置生效
cd /root/kt/mrdocs/deployment/docker
docker-compose down
docker-compose up -d

# 4. 验证环境变量
docker exec mrdocs-safe-app env | grep DJANGO
```

### 修改 Nginx 配置

```bash
# 1. 编辑 Nginx 配置
vim /root/kt/mrdocs/deployment/nginx/nginx.conf
vim /root/kt/mrdocs/deployment/nginx/mrdoc.conf

# 2. 测试配置文件语法
docker exec mrdocs-safe-nginx nginx -t

# 3. 重启 Nginx
docker-compose restart mrdocs-safe-nginx

# 4. 查看日志确认
docker logs mrdocs-safe-nginx
```

### 修改应用配置

```bash
# 1. 编辑配置文件
vim /root/kt/mrdocs/config/config.ini

# 2. 重启应用
docker-compose restart mrdocs-safe-app

# 3. 验证配置生效
docker logs -f mrdocs-safe-app
```

---

## 容器管理

### 重启单个服务

```bash
# 重启应用容器
docker-compose restart mrdocs-safe-app

# 重启 Nginx
docker-compose restart mrdocs-safe-nginx

# 重启 Redis
docker-compose restart mrdocs-safe-redis
```

### 重启所有服务

```bash
cd /root/kt/mrdocs/deployment/docker
docker-compose restart
```

### 完全重建服务

```bash
# 1. 停止并删除容器
docker-compose down

# 2. 重新构建镜像
docker-compose build --no-cache

# 3. 启动服务
docker-compose up -d

# 4. 查看启动日志
docker-compose logs -f
```

### 清理未使用的资源

```bash
# 清理停止的容器
docker container prune -f

# 清理未使用的镜像
docker image prune -a -f

# 清理未使用的卷
docker volume prune -f

# 清理所有未使用的资源
docker system prune -a -f --volumes
```

---

## 监控和日志

### 实时监控

```bash
# 监控容器资源使用
docker stats mrdocs-safe-app mrdocs-safe-nginx mrdocs-safe-redis

# 监控磁盘使用
df -h /root/kt/mrdocs/

# 监控数据库大小
du -sh /root/kt/mrdocs/config/db.sqlite3

# 监控媒体文件大小
du -sh /root/kt/mrdocs/media/
```

### 日志管理

```bash
# 查看实时日志（所有服务）
cd /root/kt/mrdocs/deployment/docker
docker-compose logs -f

# 查看特定时间段的日志
docker logs mrdocs-safe-app --since="2025-09-30T10:00:00" --until="2025-09-30T11:00:00"

# 导出日志到文件
docker logs mrdocs-safe-app > /var/log/mrdocs_$(date +%Y%m%d).log

# 清理日志（Docker 会自动管理日志，但可以手动清理）
truncate -s 0 $(docker inspect --format='{{.LogPath}}' mrdocs-safe-app)
```

### 性能分析

```bash
# 查看容器进程
docker exec mrdocs-safe-app ps aux

# 查看应用请求耗时
docker logs mrdocs-safe-app | grep "GET" | tail -100

# 查看数据库查询（需要启用 Django 调试工具栏）
docker exec -it mrdocs-safe-app python manage.py shell
>>> from django.db import connection
>>> connection.queries
```

---

## 常见维护场景

### 场景1：应用响应慢

```bash
# 1. 查看容器资源使用
docker stats mrdocs-safe-app

# 2. 查看应用日志
docker logs --tail 200 mrdocs-safe-app | grep -i error

# 3. 检查数据库大小
du -h /root/kt/mrdocs/config/db.sqlite3

# 4. 清理过期会话
docker exec mrdocs-safe-app python manage.py clearsessions

# 5. 重启应用
docker-compose restart mrdocs-safe-app

# 6. 如果是静态文件慢，检查 Nginx
docker logs mrdocs-safe-nginx | tail -100
```

### 场景2：磁盘空间不足

```bash
# 1. 查看磁盘使用
df -h

# 2. 查找大文件
du -sh /root/kt/mrdocs/* | sort -hr | head -10

# 3. 清理 Docker 资源
docker system prune -a -f

# 4. 清理日志文件
find /root/kt/mrdocs/logs -name "*.log" -mtime +30 -delete

# 5. 清理旧备份
find /backup -name "*.tar.gz" -mtime +30 -delete

# 6. 压缩媒体文件（如果太大）
cd /root/kt/mrdocs/media
find . -name "*.jpg" -exec jpegoptim --max=85 {} \;
```

### 场景3：忘记管理员密码

```bash
# 重置管理员密码
docker exec -it mrdocs-safe-app python manage.py changepassword admin

# 或者在 Django Shell 中重置
docker exec -it mrdocs-safe-app python manage.py shell
>>> from django.contrib.auth.models import User
>>> user = User.objects.get(username='admin')
>>> user.set_password('new_password')
>>> user.save()
```

### 场景4：Redis 连接失败

```bash
# 1. 检查 Redis 容器状态
docker ps --filter "name=redis"

# 2. 测试 Redis 连接
docker exec mrdocs-safe-redis redis-cli -a redispassword123 ping

# 3. 查看 Redis 日志
docker logs mrdocs-safe-redis

# 4. 重启 Redis
docker-compose restart mrdocs-safe-redis

# 5. 清空 Redis 缓存（谨慎操作）
docker exec mrdocs-safe-redis redis-cli -a redispassword123 FLUSHDB
```

### 场景5：端口冲突

```bash
# 1. 检查端口占用
netstat -tulpn | grep 8081

# 2. 停止冲突的服务
systemctl stop conflicting-service

# 3. 或修改 docker-compose.yml 中的端口映射
vim /root/kt/mrdocs/deployment/docker/docker-compose.yml
# 修改: - "8081:80" 为 - "8090:80"

# 4. 重启服务
docker-compose down
docker-compose up -d
```

### 场景6：容器无法启动

```bash
# 1. 查看容器状态
docker ps -a --filter "name=mrdocs-safe"

# 2. 查看容器日志
docker logs mrdocs-safe-app

# 3. 检查配置文件语法
docker-compose config

# 4. 检查磁盘空间
df -h

# 5. 检查权限
ls -la /root/kt/mrdocs/config/

# 6. 完全重建
docker-compose down -v
docker-compose up -d --build
```

---

## 更新流程检查清单

在执行更新前，请确认：

- [ ] 已备份数据库
- [ ] 已备份媒体文件
- [ ] 已记录当前版本/commit
- [ ] 已阅读更新日志
- [ ] 了解需要执行的迁移
- [ ] 已在测试环境验证（如有）
- [ ] 选择合适的维护窗口
- [ ] 通知相关用户（如需要）

更新后验证：

- [ ] 所有容器正常运行
- [ ] 应用可以正常访问
- [ ] 静态文件加载正常
- [ ] 数据库迁移成功
- [ ] 日志无严重错误
- [ ] 功能测试通过

---

## 快速参考

### 常用命令速查

```bash
# 重启应用
docker-compose restart mrdocs-safe-app

# 查看日志
docker logs -f mrdocs-safe-app

# 执行迁移
docker exec mrdocs-safe-app python manage.py migrate

# 收集静态文件
docker exec mrdocs-safe-app python manage.py collectstatic --noinput

# 进入容器
docker exec -it mrdocs-safe-app bash

# 备份数据库
cp /root/kt/mrdocs/config/db.sqlite3 /backup/db_$(date +%Y%m%d_%H%M%S).sqlite3

# 完全重建
cd /root/kt/mrdocs/deployment/docker && docker-compose down && docker-compose up -d --build
```

---

**文档版本**: v1.0
**更新日期**: 2025-09-30
**维护负责人**: Arise
