# MrDoc 部署环境信息

## 📋 环境概览

**部署时间**: 2025-09-30
**服务器IP**: 10.23.72.66（内网）
**部署方式**: Docker Compose
**数据库**: SQLite3
**缓存**: Redis 7
**Web服务器**: Nginx + Gunicorn

---

## 🌐 服务访问信息

### 1. Web 应用（主入口）

**访问地址**:
- 内网: `http://10.23.72.66:8081`
- 外网: `http://202.79.167.23:8081`（如已配置）
- 本地: `http://localhost:8081`

**容器名称**: `mrdocs-safe-nginx` + `mrdocs-safe-app`

**端口映射**:
```
外部端口 8081 → Nginx 容器端口 80 → 应用容器端口 8000
外部端口 8443 → Nginx 容器端口 443 (HTTPS，未启用)
```

**架构流程**:
```
用户请求 → Nginx (8081) → 反向代理 → Django App (8000)
                      ↓
                  静态文件直接返回
```

---

### 2. 管理员账号

**登录地址**: `http://10.23.72.66:8081/admin/`

| 项目 | 值 |
|------|-----|
| 用户名 | `admin` |
| 密码 | `admin123456` |
| 邮箱 | `admin@example.com` |

**⚠️ 安全建议**:
- 首次登录后立即修改密码
- 使用强密码（建议：大小写字母+数字+特殊字符，12位以上）
- 定期更换密码

---

### 3. Redis 缓存

**容器名称**: `mrdocs-safe-redis`

**访问方式**:

#### 从宿主机访问
```bash
# 连接命令
redis-cli -h 10.23.72.66 -p 6380 -a redispassword123

# 或使用本地连接
redis-cli -p 6380 -a redispassword123
```

#### 从应用容器访问
```bash
# 进入应用容器
docker exec -it mrdocs-safe-app bash

# 连接 Redis（容器内部）
redis-cli -h mrdocs-safe-redis -p 6379 -a redispassword123
```

**连接信息**:
| 项目 | 值 |
|------|-----|
| 主机（外部） | `10.23.72.66` |
| 端口（外部） | `6380` |
| 主机（容器内） | `mrdocs-safe-redis` |
| 端口（容器内） | `6379` |
| 密码 | `redispassword123` |
| 数据库编号 | `4` |

**常用命令**:
```bash
# 测试连接
redis-cli -p 6380 -a redispassword123 ping

# 查看信息
redis-cli -p 6380 -a redispassword123 info

# 查看所有键
redis-cli -p 6380 -a redispassword123 --scan

# 查看特定数据库
redis-cli -p 6380 -a redispassword123 -n 4 keys '*'

# 清空缓存（谨慎操作！）
redis-cli -p 6380 -a redispassword123 -n 4 FLUSHDB
```

---

### 4. 数据库（SQLite）

**数据库类型**: SQLite3

**数据库位置**:
- 宿主机: `/root/kt/mrdocs/config/db.sqlite3`
- 容器内: `/app/config/db.sqlite3`

**访问方式**:
```bash
# 从宿主机访问
sqlite3 /root/kt/mrdocs/config/db.sqlite3

# 从容器内访问
docker exec -it mrdocs-safe-app sqlite3 /app/config/db.sqlite3

# 通过 Django Shell 访问
docker exec -it mrdocs-safe-app python manage.py dbshell
```

**常用 SQL 命令**:
```sql
-- 查看所有表
.tables

-- 查看表结构
.schema auth_user

-- 查询用户
SELECT id, username, email, is_superuser FROM auth_user;

-- 退出
.quit
```

**备份命令**:
```bash
cp /root/kt/mrdocs/config/db.sqlite3 /backup/db_$(date +%Y%m%d_%H%M%S).sqlite3
```

---

### 5. Nginx 配置

**容器名称**: `mrdocs-safe-nginx`

**配置文件位置**:
- 主配置: `/root/kt/mrdocs/deployment/nginx/nginx.conf`
- 站点配置: `/root/kt/mrdocs/deployment/nginx/mrdoc.conf`

**日志查看**:
```bash
# 实时查看访问日志
docker logs -f mrdocs-safe-nginx

# 查看错误日志
docker logs mrdocs-safe-nginx 2>&1 | grep error

# 最近100行日志
docker logs --tail 100 mrdocs-safe-nginx
```

**配置测试**:
```bash
# 测试配置文件语法
docker exec mrdocs-safe-nginx nginx -t

# 重新加载配置（无需重启）
docker exec mrdocs-safe-nginx nginx -s reload

# 重启 Nginx
docker-compose restart mrdocs-safe-nginx
```

**静态文件路径**:
- 容器内: `/var/www/static/`
- 宿主机: `/root/kt/mrdocs/static/`

**媒体文件路径**:
- 容器内: `/var/www/media/`
- 宿主机: `/root/kt/mrdocs/media/`

---

## 🔐 安全凭据汇总

### Django 应用

| 配置项 | 值 |
|--------|-----|
| SECRET_KEY | `django_safe_secret_6WZlZsnpSV78ie9OZDmXPFodGnGWc2FNjJBuOIQqhPc` |
| DEBUG | `False` |
| ALLOWED_HOSTS | `*` |

### 管理员账号

| 配置项 | 值 |
|--------|-----|
| 用户名 | `admin` |
| 密码 | `admin123456` |
| 邮箱 | `admin@example.com` |

### Redis 凭据

| 配置项 | 值 |
|--------|-----|
| 密码 | `redispassword123` |
| 数据库 | `4` |

---

## 📁 目录结构

### 项目文件位置

```
/root/kt/mrdocs/
├── config/
│   ├── db.sqlite3           # SQLite 数据库文件
│   ├── config.ini           # 应用配置文件
│   └── uwsgi.ini            # uWSGI 配置（未使用）
├── media/                   # 媒体文件（用户上传）
├── static/                  # 静态文件（CSS/JS/图片）
├── logs/                    # 日志文件
├── deployment/
│   ├── docker/
│   │   ├── docker-compose.yml    # Docker 编排文件
│   │   ├── Dockerfile.mrdoc      # 应用镜像构建文件
│   │   └── entrypoint.sh         # 容器启动脚本
│   └── nginx/
│       ├── nginx.conf            # Nginx 主配置
│       └── mrdoc.conf            # MrDoc 站点配置
└── deployment/
    ├── 部署文档.md
    ├── 维护操作手册.md
    ├── 安全更新流程.md
    └── 部署环境信息.md       # 本文件
```

### 备份目录

```
/backup/mrdocs/
└── YYYYMMDD_HHMMSS/        # 按时间戳命名的备份
    ├── db.sqlite3          # 数据库备份
    ├── config.tar.gz       # 配置文件备份
    ├── media.tar.gz        # 媒体文件备份（可选）
    ├── git_version.txt     # Git 版本记录
    ├── container_status.txt # 容器状态记录
    └── update_log.txt      # 更新日志
```

---

## 🐳 Docker 容器信息

### 容器列表

| 容器名称 | 镜像 | 状态 | 端口映射 |
|---------|------|------|---------|
| mrdocs-safe-nginx | nginx:alpine | Up (healthy) | 8081→80, 8443→443 |
| mrdocs-safe-app | docker-mrdocs-safe-app | Up (healthy) | 内网8000 |
| mrdocs-safe-redis | redis:7-alpine | Up (healthy) | 6380→6379 |

### 网络信息

**网络名称**: `docker_mrdocs-safe-network`

**网络类型**: Bridge

**子网配置**:
- 子网: `172.31.0.0/16`
- 网关: `172.31.0.1`

**容器内网地址**:
```bash
# 查看容器IP
docker inspect mrdocs-safe-app --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}'
docker inspect mrdocs-safe-nginx --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}'
docker inspect mrdocs-safe-redis --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}'
```

### 数据卷

| 卷名称 | 用途 | 挂载点 |
|--------|------|--------|
| sqlite_data | SQLite 数据持久化 | /app/db |
| mrdocs-safe_redis_data | Redis 数据持久化 | /data |

---

## 🔧 常用操作命令

### 查看服务状态
```bash
# 查看所有容器
docker ps --filter "name=mrdocs-safe"

# 查看容器详细信息
docker inspect mrdocs-safe-app

# 查看容器资源使用
docker stats mrdocs-safe-app mrdocs-safe-nginx mrdocs-safe-redis
```

### 查看日志
```bash
# 应用日志
docker logs -f mrdocs-safe-app

# Nginx 日志
docker logs -f mrdocs-safe-nginx

# Redis 日志
docker logs -f mrdocs-safe-redis

# 所有服务日志
cd /root/kt/mrdocs/deployment/docker
docker-compose logs -f
```

### 进入容器
```bash
# 进入应用容器
docker exec -it mrdocs-safe-app bash

# 进入 Nginx 容器
docker exec -it mrdocs-safe-nginx sh

# 进入 Redis 容器
docker exec -it mrdocs-safe-redis sh
```

### 重启服务
```bash
cd /root/kt/mrdocs/deployment/docker

# 重启单个服务
docker-compose restart mrdocs-safe-app

# 重启所有服务
docker-compose restart

# 停止所有服务
docker-compose down

# 启动所有服务
docker-compose up -d
```

---

## 🌍 环境变量

### 应用环境变量

查看所有环境变量：
```bash
docker exec mrdocs-safe-app env
```

关键环境变量：
```bash
DB_ENGINE=sqlite
DB_NAME=/app/config/db.sqlite3
REDIS_HOST=mrdocs-safe-redis
REDIS_PORT=6379
REDIS_PASSWORD=redispassword123
REDIS_DB=4
DJANGO_SETTINGS_MODULE=MrDoc.settings
DJANGO_SECRET_KEY=django_safe_secret_6WZlZsnpSV78ie9OZDmXPFodGnGWc2FNjJBuOIQqhPc
DJANGO_DEBUG=False
DJANGO_ALLOWED_HOSTS=*
DJANGO_SUPERUSER_USERNAME=admin
DJANGO_SUPERUSER_EMAIL=admin@example.com
DJANGO_SUPERUSER_PASSWORD=admin123456
TZ=Asia/Shanghai
```

---

## 🔒 安全建议

### 立即执行

1. **修改默认密码**
   ```bash
   # 登录应用后台修改管理员密码
   # 访问: http://10.23.72.66:8081/admin/
   ```

2. **修改 Redis 密码**
   ```bash
   # 编辑 docker-compose.yml
   vim /root/kt/mrdocs/deployment/docker/docker-compose.yml
   # 修改: REDIS_PASSWORD=your-strong-password
   # 重启: docker-compose restart
   ```

3. **修改 Django SECRET_KEY**
   ```bash
   # 生成新的密钥
   docker exec mrdocs-safe-app python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"

   # 修改 docker-compose.yml 中的 DJANGO_SECRET_KEY
   # 重启容器
   ```

### 长期维护

1. **限制管理后台访问**
   - 配置 IP 白名单
   - 使用 VPN 访问

2. **启用 HTTPS**
   - 配置 SSL 证书
   - 修改 nginx 配置

3. **定期备份**
   - 设置自动备份脚本
   - 异地备份重要数据

4. **监控日志**
   - 定期检查错误日志
   - 设置异常告警

5. **更新依赖**
   - 定期更新 Docker 镜像
   - 更新 Python 依赖包

---

## 📞 故障排查

### 应用无法访问

```bash
# 1. 检查容器状态
docker ps --filter "name=mrdocs-safe"

# 2. 查看应用日志
docker logs --tail 50 mrdocs-safe-app

# 3. 测试应用容器
curl -I http://localhost:8081

# 4. 检查端口占用
netstat -tulpn | grep 8081
```

### Redis 连接失败

```bash
# 1. 检查 Redis 容器
docker ps --filter "name=redis"

# 2. 测试 Redis 连接
redis-cli -p 6380 -a redispassword123 ping

# 3. 查看 Redis 日志
docker logs mrdocs-safe-redis
```

### 静态文件 404

```bash
# 1. 恢复静态文件
cd /root/kt/mrdocs
git restore static/

# 2. 收集静态文件
docker exec mrdocs-safe-app python manage.py collectstatic --noinput

# 3. 重启 Nginx
docker-compose restart mrdocs-safe-nginx
```

---

## 📚 相关文档

- [部署文档](./部署文档.md) - 完整的部署流程
- [维护操作手册](./维护操作手册.md) - 日常维护操作
- [安全更新流程](./安全更新流程.md) - 代码更新指南

---

## 📝 快速参考卡片

### 一键信息查询

```bash
# 保存以下脚本为 /root/show_info.sh
cat > /root/show_info.sh << 'EOF'
#!/bin/bash
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "MrDoc 部署环境信息"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "🌐 Web访问: http://$(hostname -I | awk '{print $1}'):8081"
echo "👤 管理员: admin / admin123456"
echo "🗄️ Redis: $(hostname -I | awk '{print $1}'):6380"
echo "🔑 Redis密码: redispassword123"
echo "💾 数据库: /root/kt/mrdocs/config/db.sqlite3"
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "容器状态:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
docker ps --filter "name=mrdocs-safe" --format "table {{.Names}}\t{{.Status}}"
EOF

chmod +x /root/show_info.sh
```

使用方式：
```bash
/root/show_info.sh
```

---

**文档版本**: v1.0
**创建日期**: 2025-09-30
**维护人员**: Arise

**⚠️ 重要提示**:
- 本文档包含敏感信息，请妥善保管
- 修改密码后及时更新本文档
- 定期检查并更新配置信息
