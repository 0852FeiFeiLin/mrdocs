# 🛠️ MrDoc Ubuntu 环境准备文档

> **ubuntu_prepare.sh 脚本功能详解**

## 📋 概述

`ubuntu_prepare.sh` 是一个Ubuntu服务器的Docker环境一站式准备脚本，为MrDoc部署铺设完整的基础环境。

```
ubuntu_prepare.sh = Ubuntu服务器的Docker化部署环境准备工具
```

## 🎯 脚本主要职能

**将裸Ubuntu系统转换为具备Docker容器化能力的生产级部署环境**

- ✅ **系统级环境配置** - Docker、防火墙、性能优化
- ✅ **一次性基础设施准备** - 完成后无需重复执行
- ✅ **生产环境标准化** - 按照最佳实践配置系统参数

## 🔧 核心功能模块

### 1. 🔍 **系统检测与更新**

```bash
功能：
├── 检测Ubuntu系统版本（要求20.04+）
├── 更新系统软件包：apt update & upgrade
└── 安装基础工具：curl, wget, git, vim, unzip
```

**执行效果：**
- 确保系统版本兼容性
- 获取最新的安全更新
- 安装必要的基础工具

### 2. 🐳 **Docker生态安装**

```bash
功能：
├── 安装Docker CE（社区版）
├── 安装Docker Compose（容器编排工具）
├── 配置Docker服务自启动
└── 将当前用户加入docker组（免sudo使用）
```

**核心作用：**
- 提供容器化运行环境
- 支持多容器应用编排
- 简化容器操作权限

**安装版本：**
- Docker CE：最新稳定版
- Docker Compose：GitHub最新release版本

### 3. 🛡️ **安全配置**

```bash
功能：
├── 配置UFW防火墙
├── 开放必要端口：22(SSH), 80(HTTP), 443(HTTPS)
└── 增强系统安全基线
```

**端口配置：**
| 端口 | 协议 | 用途 | 状态 |
|------|------|------|------|
| 22 | TCP | SSH远程管理 | ✅ 开放 |
| 80 | TCP | HTTP Web服务 | ✅ 开放 |
| 443 | TCP | HTTPS安全访问 | ✅ 开放 |

### 4. 🔧 **Docker用户权限配置**

```bash
配置项目：
├── 将当前用户加入docker组
├── 启用Docker服务自启动
└── 配置用户免sudo使用Docker
```

**权限配置作用：**
- **docker组权限** - 用户可直接使用docker命令
- **服务自启动** - 系统重启后Docker自动启动
- **免sudo操作** - 简化容器操作流程

### 5. ⚡ **系统性能优化**

```bash
优化项目：
├── 文件描述符限制调整（65536）
├── 内核参数优化：
│   ├── vm.max_map_count=262144     # 内存映射限制
│   ├── vm.swappiness=1             # 减少swap使用
│   └── net.core.somaxconn=65535    # 网络连接队列
└── 应用优化配置生效
```

**性能提升：**
- 支持更多并发连接
- 优化容器内存管理
- 提升网络处理能力
- 减少磁盘IO等待

### 6. 🛠️ **运维工具安装**

```bash
工具分类：
├── 监控工具：htop, iotop, nethogs
├── 实用工具：tree, jq, sqlite3, mysql-client
└── Web服务：nginx, certbot (SSL证书工具)
```

**工具用途：**
- **htop** - 系统资源监控
- **iotop** - 磁盘IO监控
- **nethogs** - 网络流量监控
- **tree** - 目录结构显示
- **jq** - JSON数据处理
- **mysql-client** - 数据库客户端
- **nginx** - Web服务器
- **certbot** - 免费SSL证书申请

## 📊 执行前后对比

| 执行前状态 | 执行后状态 |
|------------|------------|
| 🔴 裸Ubuntu系统 | ✅ Docker化生产环境 |
| 🔴 缺少容器支持 | ✅ Docker + Docker Compose |
| 🔴 基础安全配置 | ✅ 防火墙 + 端口管理 |
| 🔴 用户权限限制 | ✅ Docker权限配置 |
| 🔴 默认系统参数 | ✅ 容器优化参数 |
| 🔴 缺少运维工具 | ✅ 完整监控工具链 |

## ✅ 脚本执行完成后效果

### 🎯 **你的服务器将具备：**

1. **🐳 完整的Docker容器化环境**
   - Docker CE 最新版
   - Docker Compose 编排工具
   - 用户免sudo操作权限

2. **🛡️ 生产级的安全配置**
   - UFW防火墙启用
   - 必要端口开放
   - 安全基线加固

3. **⚡ 性能优化的系统参数**
   - 文件描述符限制提升
   - 内核参数优化
   - 容器运行优化

4. **🔧 完整的Docker权限配置**
   - 用户加入docker组权限
   - Docker服务自启动配置
   - 免sudo容器操作环境

5. **🛠️ 齐全的运维监控工具**
   - 系统监控工具
   - 网络分析工具
   - Web服务支持

### 🔄 **持久性特征**

**为什么一次执行就够？**

- **🏗️ 基础设施性质** - Docker环境一旦安装，持续可用
- **🔒 系统级配置** - 防火墙、内核参数等配置永久生效
- **👥 用户权限设置** - docker组权限配置持久有效
- **📦 软件包管理** - 已安装的工具包持续可用
- **⚙️ 服务自启动** - Docker服务开机自动启动

## 🚀 后续部署流程

### 环境准备完成后，下一步：

```bash
# 1. 重新登录激活docker组权限
logout
ssh user@server

# 2. 验证环境就绪
docker --version
docker-compose --version

# 3. 执行MrDoc安全部署
./deploy_safe_mrdoc.sh
```

## 📝 注意事项

### ⚠️ **系统要求**
- **操作系统**: Ubuntu 20.04+
- **内存**: 最低2GB，推荐4GB+
- **磁盘**: 最低20GB，推荐50GB+
- **网络**: 稳定的互联网连接

### 🔧 **执行要求**
- 使用普通用户执行（非root）
- 确保用户具有sudo权限
- 服务器有公网IP访问能力

### 💡 **最佳实践**
- 建议在全新Ubuntu系统上执行
- 执行前做好系统备份
- 确保网络连接稳定
- 准备好域名（可选）

## 🔍 脚本重复执行分析

如果服务器已经安装了所需工具，再次执行 `ubuntu_prepare.sh` 脚本会有以下结果：

### ✅ **安全的幂等操作**

#### 1. **Docker & Docker Compose**
```bash
# 脚本有检测机制
if command -v docker &> /dev/null; then
    print_message "Docker 已安装: $(docker --version)"
    return 0  # 直接跳过安装
fi
```
**结果**: ✅ 检测到已安装，直接跳过，显示版本信息

#### 2. **系统软件包**
```bash
sudo apt-get install -y curl wget git vim unzip
```
**结果**: ✅ apt包管理器有幂等性，已安装的包会被跳过

#### 3. **用户组权限**
```bash
sudo usermod -aG docker $USER
```
**结果**: ✅ 用户已在docker组中，命令安全执行，不会重复添加

#### 4. **防火墙配置**
```bash
sudo ufw allow ssh
sudo ufw allow 80/tcp
```
**结果**: ✅ UFW规则重复添加是安全的，不会创建重复规则

### 💡 **重复执行总结**

**重复执行 `ubuntu_prepare.sh` 通常是安全的：**

- ✅ **大部分操作具有幂等性**，已安装的组件会被跳过
- ✅ **系统不会被破坏**，最多是配置文件有轻微重复内容
- ✅ **完全自动化执行**，无需任何手动干预
- ✅ **可以放心多次执行**，脚本会智能跳过已完成的步骤

## 🎉 总结

**`ubuntu_prepare.sh` 是一次性的环境准备脚本，它将：**

- 🔄 **转换** - 将裸Ubuntu转换为Docker化环境
- 🛡️ **加固** - 提供生产级安全配置
- ⚡ **优化** - 调整系统参数提升性能
- 🛠️ **装备** - 安装完整的运维工具链

**执行完成后，你的服务器就具备了运行MrDoc容器化应用的所有基础条件。如果需要重复执行，脚本会智能跳过已完成的步骤，确保执行安全。**

---

📋 **下一步文档**: [SAFE_DEPLOYMENT_PLAN.md](./SAFE_DEPLOYMENT_PLAN.md) - MrDoc安全部署方案