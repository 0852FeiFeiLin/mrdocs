# MrDoc Docker 部署文档

## 项目概述

本文档记录 MrDoc 项目使用 Docker Compose 的完整部署流程和配置说明。

## 技术架构

- **应用框架**: Django 4.2 + Python 3.11
- **数据库**: SQLite3
- **缓存**: Redis 7
- **Web服务器**: Nginx + Gunicorn
- **容器化**: Docker + Docker Compose

## 端口配置

| 服务 | 容器端口 | 宿主机端口 | 说明 |
|------|---------|-----------|------|
| Nginx | 80 | 8081 | 主入口，提供静态文件和反向代理 |
| Nginx HTTPS | 443 | 8443 | HTTPS端口（可选） |
| Django App | 8000 | - | 仅内网访问，通过Nginx代理 |
| Redis | 6379 | 6380 | Redis缓存服务 |

**访问地址**: `http://your-server-ip:8081`

## 目录结构

```
/root/kt/mrdocs/
├── deployment/
│   ├── docker/
│   │   ├── docker-compose.yml    # Docker编排配置
│   │   ├── Dockerfile.mrdoc      # 应用镜像构建文件
│   │   └── entrypoint.sh         # 容器启动脚本
│   └── nginx/
│       ├── nginx.conf            # Nginx主配置
│       └── mrdoc.conf            # MrDoc站点配置
├── static/                       # 静态文件目录
├── media/                        # 媒体文件目录
├── config/                       # 配置文件目录
│   ├── config.ini               # 应用配置
│   └── db.sqlite3               # SQLite数据库
└── logs/                        # 日志目录
```

## 部署步骤

### 1. 前置条件

```bash
# 确保已安装 Docker 和 Docker Compose
docker --version
docker-compose --version

# 确保 Git 可用
git --version
```

### 2. 克隆项目

```bash
cd /root/kt/
git clone https://github.com/0852FeiFeiLin/mrdocs.git
cd mrdocs
```

### 3. 恢复静态文件

```bash
# 静态文件可能在 Git 中被标记为删除，需要恢复
git restore static/
```

### 4. 配置目录权限

```bash
# 确保容器有权限访问挂载目录
chmod -R 777 config/ static/ media/ logs/
```

### 5. 启动服务

```bash
cd deployment/docker
docker-compose up -d --build
```

### 6. 验证部署

```bash
# 查看容器状态
docker ps --filter "name=mrdocs-safe"

# 查看应用日志
docker logs mrdocs-safe-app

# 测试应用访问
curl -I http://localhost:8081

# 测试静态文件
curl -I http://localhost:8081/static/layui/layui.js
```

### 7. 访问应用

打开浏览器访问：`http://your-server-ip:8081`

默认管理员账号：
- 用户名: `admin`
- 密码: `admin123456`

## 常见问题排查

### 1. 容器不断重启

**现象**: 容器状态显示 `Restarting`

**排查步骤**:
```bash
# 查看容器日志
docker logs --tail 50 mrdocs-safe-app

# 常见原因及解决方案：
# 1. 权限问题
chmod -R 777 /root/kt/mrdocs/{config,static,media,logs}

# 2. SQLite数据库文件无法创建
# 检查 config 目录是否存在且有写权限
mkdir -p /root/kt/mrdocs/config
chmod 777 /root/kt/mrdocs/config
```

### 2. 静态文件 404

**现象**: CSS、JS、图片等资源无法加载

**解决方案**:
```bash
# 1. 恢复静态文件
cd /root/kt/mrdocs
git restore static/

# 2. 检查 Nginx 容器内挂载
docker exec mrdocs-safe-nginx ls -la /var/www/static/

# 3. 重启容器
cd deployment/docker
docker-compose restart mrdocs-safe-nginx
```

### 3. 数据库迁移失败

**现象**: 启动日志显示 `数据库迁移失败`

**解决方案**:
```bash
# 手动执行迁移
docker exec -it mrdocs-safe-app python manage.py migrate

# 如果仍失败，删除数据库重新初始化
rm /root/kt/mrdocs/config/db.sqlite3
docker-compose restart mrdocs-safe-app
```

### 4. Gunicorn 启动失败

**现象**: 日志显示 `gunicorn: not found`

**原因**: Gunicorn 安装在用户目录，不在 PATH 中

**解决方案**: 已在 `entrypoint.sh` 中使用完整路径：
```bash
/home/mrdoc/.local/bin/gunicorn
```

## 服务管理命令

### 启动服务
```bash
cd /root/kt/mrdocs/deployment/docker
docker-compose up -d
```

### 停止服务
```bash
docker-compose down
```

### 重启服务
```bash
docker-compose restart
```

### 查看日志
```bash
# 查看所有容器日志
docker-compose logs -f

# 查看特定容器日志
docker logs -f mrdocs-safe-app
docker logs -f mrdocs-safe-nginx
docker logs -f mrdocs-safe-redis
```

### 重建容器
```bash
docker-compose down
docker-compose up -d --build --force-recreate
```

## 数据备份

### 1. 备份 SQLite 数据库
```bash
cp /root/kt/mrdocs/config/db.sqlite3 /backup/db.sqlite3.$(date +%Y%m%d)
```

### 2. 备份媒体文件
```bash
tar -czf /backup/media_$(date +%Y%m%d).tar.gz /root/kt/mrdocs/media/
```

### 3. 备份配置文件
```bash
tar -czf /backup/config_$(date +%Y%m%d).tar.gz /root/kt/mrdocs/config/
```

### 4. 完整备份脚本
```bash
#!/bin/bash
BACKUP_DIR="/backup/mrdocs_$(date +%Y%m%d_%H%M%S)"
mkdir -p $BACKUP_DIR

cp /root/kt/mrdocs/config/db.sqlite3 $BACKUP_DIR/
tar -czf $BACKUP_DIR/media.tar.gz /root/kt/mrdocs/media/
tar -czf $BACKUP_DIR/config.tar.gz /root/kt/mrdocs/config/

echo "备份完成: $BACKUP_DIR"
```

## 数据恢复

### 1. 恢复数据库
```bash
# 停止应用
docker-compose stop mrdocs-safe-app

# 恢复数据库文件
cp /backup/db.sqlite3.20250930 /root/kt/mrdocs/config/db.sqlite3

# 启动应用
docker-compose start mrdocs-safe-app
```

### 2. 恢复媒体文件
```bash
tar -xzf /backup/media_20250930.tar.gz -C /root/kt/mrdocs/
```

## 配置说明

### 环境变量 (docker-compose.yml)

```yaml
environment:
  - DB_ENGINE=sqlite                    # 数据库引擎
  - DB_NAME=/app/config/db.sqlite3      # 数据库文件路径
  - REDIS_HOST=mrdocs-safe-redis        # Redis主机
  - REDIS_PORT=6379                     # Redis端口
  - REDIS_PASSWORD=redispassword123     # Redis密码
  - DJANGO_SECRET_KEY=***               # Django密钥
  - DJANGO_DEBUG=False                  # 调试模式
  - DJANGO_ALLOWED_HOSTS=*              # 允许的主机
  - DJANGO_SUPERUSER_USERNAME=admin     # 管理员用户名
  - DJANGO_SUPERUSER_EMAIL=admin@example.com  # 管理员邮箱
  - DJANGO_SUPERUSER_PASSWORD=admin123456     # 管理员密码
  - REDIS_DB=4                          # Redis数据库编号
  - TZ=Asia/Shanghai                    # 时区
```

### Nginx 配置要点

**位置**: `deployment/nginx/nginx.conf`

- Upstream 后端地址: `mrdocs-safe-app:8000`
- Worker 进程: `auto`
- Worker 连接数: `1024`

**位置**: `deployment/nginx/mrdoc.conf`

- 静态文件路径: `/var/www/static/`
- 媒体文件路径: `/var/www/media/`
- 客户端上传限制: `100M`
- 静态文件缓存: `30天`
- 媒体文件缓存: `7天`

## 性能优化建议

### 1. Gunicorn Workers
```bash
# 当前配置: 4 workers
# 推荐公式: (2 × CPU核心数) + 1
# 修改位置: deployment/docker/entrypoint.sh
```

### 2. Redis 内存限制
```yaml
# 在 docker-compose.yml 中添加
command: redis-server --requirepass redispassword123 --maxmemory 256mb --maxmemory-policy allkeys-lru
```

### 3. Nginx 缓存
```nginx
# 在 nginx.conf 中启用缓存
proxy_cache_path /tmp/nginx_cache levels=1:2 keys_zone=cache:10m inactive=60m;
```

## 安全建议

### 1. 修改默认密码
```bash
# 登录后立即修改管理员密码
# 同时修改 docker-compose.yml 中的密码
```

### 2. 修改 Redis 密码
```yaml
# 在 docker-compose.yml 中修改
- REDIS_PASSWORD=your-strong-password
command: redis-server --requirepass your-strong-password
```

### 3. 修改 Django SECRET_KEY
```yaml
# 生成新的 SECRET_KEY
python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"

# 在 docker-compose.yml 中替换
- DJANGO_SECRET_KEY=your-generated-secret-key
```

### 4. 配置 HTTPS (可选)
```bash
# 准备 SSL 证书
mkdir -p deployment/nginx/ssl
cp your-cert.pem deployment/nginx/ssl/
cp your-key.pem deployment/nginx/ssl/

# 在 mrdoc.conf 中启用 HTTPS 配置段
```

## 监控和日志

### 应用日志位置
```bash
# 容器内日志
docker exec mrdocs-safe-app ls /app/logs/

# Nginx 日志
docker logs mrdocs-safe-nginx

# Gunicorn 日志（输出到 stdout）
docker logs mrdocs-safe-app
```

### 健康检查
```bash
# 应用健康检查
curl http://localhost:8081/

# Redis 健康检查
docker exec mrdocs-safe-redis redis-cli -a redispassword123 ping
```

## 更新部署

### 1. 拉取最新代码
```bash
cd /root/kt/mrdocs
git pull origin master
```

### 2. 恢复静态文件（如需要）
```bash
git restore static/
```

### 3. 重建并重启容器
```bash
cd deployment/docker
docker-compose down
docker-compose up -d --build
```

### 4. 执行数据库迁移（如有新迁移）
```bash
docker exec mrdocs-safe-app python manage.py migrate
```

## 故障恢复流程

### 完全重新部署
```bash
# 1. 备份数据
cp /root/kt/mrdocs/config/db.sqlite3 /backup/
tar -czf /backup/media.tar.gz /root/kt/mrdocs/media/

# 2. 停止并删除所有容器
cd /root/kt/mrdocs/deployment/docker
docker-compose down -v

# 3. 恢复静态文件
cd /root/kt/mrdocs
git restore static/

# 4. 设置权限
chmod -R 777 config/ static/ media/ logs/

# 5. 重新部署
cd deployment/docker
docker-compose up -d --build

# 6. 恢复数据
cp /backup/db.sqlite3 /root/kt/mrdocs/config/
```

## 技术支持

- **项目地址**: https://github.com/0852FeiFeiLin/mrdocs
- **官方文档**: 见项目 README.md
- **问题反馈**: GitHub Issues

## 部署清单

部署完成后，请确认以下项目：

- [ ] 所有容器状态为 `Up` 和 `healthy`
- [ ] 可以访问 `http://server-ip:8081`
- [ ] 静态文件（CSS/JS/图片）加载正常
- [ ] 可以使用管理员账号登录
- [ ] 已修改默认密码
- [ ] 已配置数据备份计划
- [ ] 日志输出正常

---

**部署日期**: 2025-09-30
**部署人员**: Arise
**部署状态**: ✅ 验收通过
